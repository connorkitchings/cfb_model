---
date: 2025-11-22
branch: main
task: [IMPL-task:ATS-METRICS] - Overhaul ATS metrics, fix feature selection, and cleanup project.
---

# Session Log: 2025-11-22

## Wins

- **ATS Metrics Overhaul**: Completely rewrote `compute_ats_metrics` in `scripts/run_experiment.py` to use actual betting lines from CFBD data.
  - Implemented correct edge calculation: `edge = prediction - (-line)` (negating line to match margin convention).
  - Added support for both **spread** and **total** targets with separate betting logic.
  - Implemented proper push handling: exact ties are now excluded from the win rate calculation (`wins / (wins + losses)`).
  - Verified results: Spread hit rates corrected from inflated 71% to realistic ~47-49%.
- **Feature Selector Fix**: Fixed a critical bug in `src/features/selector.py` where recency features (`_last_1`, etc.) were not being selected because the code tried to construct names instead of scanning available columns.
  - Result: Recency features are now properly included in models.
- **Feature Consistency**: Added logic to `scripts/run_experiment.py` to find the intersection of features across train and all test years.
  - Solved `CatBoostError` caused by feature set mismatches between years (e.g., 2023 having features 2024 lacked).
- **Profitable Totals Model**: The `totals_pace_interaction_v1` experiment achieved a **54.6% hit rate** (495-412-18 record), which is profitable (>52.4% break-even).
- **Project Cleanup**:

  - Aggregated 62 daily session logs (Sept-Oct) into 6 weekly summaries, archiving originals.
  - Archived unused points-for modeling scripts and test scripts.
  - Deleted ~3MB of old Hydra outputs.

- **Data Directory Refactor**:
  - Identified external data root at `/Volumes/CK SSD/Coding Projects/cfb_model/`.
  - Verified compliance with Data Science Cookiecutter (DSC) standards (`raw/`, `processed/`).
  - Created `interim/` directory to complete the standard structure.
  - Updated `src/config.py` and `src/utils/local_storage.py` to support `interim` data type.
- **Strategic Review**: Analyzed project structure against DSC standards. Decided against full refactor as current structure is superior for MLOps/Hydra workflows.
- **Root Cleanup**: Deleted unused `catboost_info/` and `site/` directories.

## Blockers

- **Initial ATS Logic**: The original implementation was fundamentally flawed (no betting lines, wrong sign logic). This required a complete rewrite and deep dive into betting fundamentals.
- **Feature Mismatch**: CatBoost failed when training on 2023 and predicting on 2024 due to differing feature sets. Fixed by enforcing common features.

## Artifacts & Links

- **Walkthrough**: `docs/walkthrough.md` (created in artifacts) - Detailed documentation of the ATS fix and experiment results.
- **Cleanup Log**: `CLEANUP_LOG.md` - Record of all archival and deletion actions.
- **Structure Strategy**: `structure_strategy.md` (in artifacts) - Analysis of project structure vs. DSC standards.
- **Updated Docs**:
  - `docs/project_org/modeling_baseline.md`: Updated betting policy with new ATS logic.
  - `docs/project_org/feature_catalog.md`: Removed deprecated `sec_per_play` and clarified recency.

## Handoff

- **Stopping Point**: All planned refactors and cleanups are complete. The experiment framework is robust, ATS metrics are accurate, and the project structure is clean.
- **Next Immediate Task**:
  - Analyze edge buckets to see if higher-edge bets perform better.
  - Consider running a full backtest with the profitable totals model.
  - Revisit points-for modeling (scripts are archived but can be restored).
- **Known Issues**: None. Health checks passed.
- **Next Session Context**: Ready for deep analysis of model performance or starting the next phase of modeling (e.g., probabilistic outputs).
