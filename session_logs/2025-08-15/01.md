---
date: 2025-08-15
branch: main
task: [IMPL-task:storage-agg-csv] - Standardize processed CSV layout, split aggregations CLI, add logging
---

## Wins

- Standardized processed storage to CSV and finalized partition scheme:
  - byplay: one folder per game (`year/ week/ game`)
  - drives: one folder per game (`year/ week/ game`)
  - team_game: per week/team (`year/ week/ team`)
  - team_season + team_season_adj: one folder per team per season, split by `side=offense|defense`
- Added per-game logging (season, week, game_id, home vs away) in aggregation writes (byplay/drives).
- Split aggregations into separate CLI `scripts/aggregations_cli.py` (uses `CFB_MODEL_DATA_ROOT`),
  removed from `ingest_cli.py`.
- Updated `LocalStorage.read_index` to read nested CSV partitions; converted training/prediction
  scripts to `LocalStorage` CSV.
- Synced docs to CSV storage and new processed layout.

## Blockers

- Running CLI within this interface was interrupted; could not execute full preagg here. Needs
  local run to confirm.

## Artifacts & Links

- Code: `src/cfb_model/data/aggregations/persist.py`, `scripts/aggregations_cli.py`, `src/cfb_model/data/storage/local_storage.py`
- Docs: `docs/cfbd/data_ingestion.md`, `README.md`
- Decisions: [PRD-decision:2025-08-14] CSV standardization (raw + processed)

## Handoff

- Stopping Point: Aggregation layout refactor complete; logging added; docs updated.
- Next Immediate Task: Run `python scripts/aggregations_cli.py preagg --year 2014` and `--year 2024`
   locally; verify logs and folder outputs; then update validation utilities to reflect final layout.
- Known Issues: CLI execution in this environment is interrupted; validation module still references
  some older checks and needs a pass for CSV layout and per-team side folders.
- Next Session Context: Implement processed-data validation (row counts via CSV, dedup checks per
  folder), add unit tests for `aggregate_drives` and `aggregate_team_game`, and wire training to
  new team-season aggregates.
