---
date: 2025-08-10
branch: main
task: [IMPL-task:local-parquet-refactor] - Remove Supabase, add local Parquet storage, CLI, and validation
---

## Wins

- Completed refactor of `games` and `plays` ingestion to write partitioned Parquet locally via
  `pyarrow` with idempotent overwrite semantics.
- Implemented storage backend abstraction (`StorageBackend`) and local implementation
  (`LocalParquetStorage`) with per-partition `manifest.json`.
- Added CLI options to ingesters: `--data-root`, `--season_type`, `--workers`, `--exclude-seasons`
  (default excludes 2020). Normalized datetimes to US/Eastern.
- Implemented validation utility (`src/cfb_model/data/validation.py`) for manifest counts,
  referential integrity (plays -> games), and duplicate detection.

## Blockers

- `compileall` surfaced env noise: `.venv/.../aenum/_py2.py` raises SyntaxError under Python 3.12.
  Action: run compile excluding `.venv` or rely on pre-commit/ruff/pytest.
- IndentationError in `scripts/ingest_plays.py` line 100 detected by compile step; needs a quick fix.

## Artifacts & Links

- Storage: `src/cfb_model/data/storage/base.py`, `src/cfb_model/data/storage/local_parquet.py`
- Ingesters: `src/cfb_model/data/ingestion/games.py`, `src/cfb_model/data/ingestion/plays.py`, `src/cfb_model/data/ingestion/base.py`
- Validation: `src/cfb_model/data/validation.py`
- Decisions: [PRD-decision:2025-08-10-LocalParquet]
- Checklists: See [QG:PreCommit]

## Handoff

- Stopping Point: Ingestion for games/plays refactored to local Parquet with validation utilities
  in place.
- Next Immediate Task: Fix `scripts/ingest_plays.py` indentation (line ~100). Run `compileall`
  excluding `.venv` and execute validation over a known season (e.g., 2022).
- Known Issues: Env compile noise; legacy Supabase docs need deprecation note.
- Next Session Context: Extend refactor to other entities (venues, teams, drives, betting_lines).
  Add end-to-end test run and document validation workflow in `docs/cfbd/data_ingestion.md`.
