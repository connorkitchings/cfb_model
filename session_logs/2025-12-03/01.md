# Dev Session Log — 2025-12-03

**Session ID:** 01  
**Date:** 2025-12-03  
**Duration:** ~4 hours  
**Focus Area:** 2025 Backfill, Model Retraining, ML Workflow

---

## Session Summary

### Objectives

1. Complete 2025 weekly predictions and scored bets backfill (weeks 2-15)
2. Establish proper ML workflow (train/test/deploy split)
3. Retrain models with correct data split (2019/2021-2023 only)
4. Fix System Info metrics and email formatting

### Key Accomplishments

**✅ 2025 Backfill Completed**

- Ingested Week 14 plays data (11,908 plays, 67 games)
- Ingested Week 15 games (9 conference championship games)
- Ingested betting lines for all 2025 weeks
- Generated predictions for weeks 2-15
- Scored all completed games (weeks 2-14)

**✅ ML Workflow Established**

- Created [`docs/project_org/ml_workflow.md`](file:///Users/connorkitchings/Desktop/Repositories/cfb_model/docs/project_org/ml_workflow.md) documenting standard train/test/deploy process
- Train: 2019, 2021-2023 (FBS only)
- Test: 2024 (hold-out year)
- Deploy: 2025 (live production)

**✅ Models Retrained with Proper Split**

- Updated experiment configs to exclude 2024 from training
- Retrained `spread_catboost_ppr` v5 (5 ensemble members)
- Retrained `totals_xgboost_ppr` v5 (5 ensemble members)
- Backfilled all 2024 predictions (weeks 2-16)
- Backfilled all 2025 predictions (weeks 2-15)
- Scored all games with new models

**✅ Configuration Fixes**

- Fixed threshold mismatch in `conf/weekly_bets/default.yaml`
- Aligned bet generation (5.0/7.5) with email reporting thresholds
- System Info now shows accurate performance metrics

**✅ Email Template Improvements**

- Fixed System Info table formatting (removed inconsistent shading)
- Added vertical borders between columns
- Changed "Hist. Wk X" to "2024 Wk X" for clarity
- Sent production email for Week 15 conference championships

---

## Technical Details

### Model Performance (After Retraining)

**2024 Season (Test Set):**

- Spread: 234-222 (51.3% win rate)
- Total: 142-99 (58.9% win rate)
- Bet Volume: 456 spread, 241 total

**2025 Season (Live Deployment):**

- Spread: 225-232 (49.2% win rate)
- Total: 115-101 (53.2% win rate)
- Bet Volume: 457 spread, 216 total

**Key Insight:** Consistent bet volumes (456 vs 457) validate proper train/test split. Performance is close to break-even, suggesting opportunities for improvement.

### Files Modified

**Configuration:**

- `conf/experiment/spread_catboost_ppr_v1.yaml` - Added `years: [2019, 2021, 2022, 2023]`
- `conf/experiment/totals_xgboost_ppr_v1.yaml` - Added `years: [2019, 2021, 2022, 2023]`
- `conf/weekly_bets/default.yaml` - Fixed threshold mismatch (10.0/3.5 → 5.0/7.5)

**Templates:**

- `templates/email_weekly_picks_v3.html` - Fixed System Info table CSS and labels

**Documentation:**

- `docs/project_org/ml_workflow.md` - New ML workflow guide

**Data:**

- Regenerated all `data/production/predictions/2024/CFB_week{2-16}_bets.csv`
- Regenerated all `data/production/predictions/2025/CFB_week{2-15}_bets.csv`
- Regenerated all `data/production/scored/2024/CFB_week{2-16}_bets_scored.csv`
- Regenerated all `data/production/scored/2025/CFB_week{2-14}_bets_scored.csv`

### Commands Executed

```bash
# Week 14 ingestion
uv run python scripts/cli.py ingest plays --year 2025 --week 14 --season-type regular
uv run python scripts/cli.py ingest games --year 2025 --week 14 --season-type regular
uv run python scripts/cli.py ingest betting_lines --year 2025 --season-type regular

# Feature regeneration
uv run python scripts/pipeline/run_pipeline_generic.py --year 2025

# Week 15 predictions
uv run python scripts/pipeline/generate_weekly_bets.py --config conf/weekly_bets/temp_week15.yaml

# Model retraining
uv run python scripts/pipeline/train_and_register.py --config-name=config experiment=spread_catboost_ppr_v1
uv run python scripts/pipeline/train_and_register.py --config-name=config experiment=totals_xgboost_ppr_v1

# Backfill 2024 and 2025
for week in 2-16; do
    uv run python scripts/pipeline/generate_weekly_bets.py --year 2024 --week $week
    uv run python scripts/pipeline/score_weekly_bets.py --year 2024 --week $week
done

for week in 2-15; do
    uv run python scripts/pipeline/generate_weekly_bets.py --year 2025 --week $week
    uv run python scripts/pipeline/score_weekly_bets.py --year 2025 --week $week
done

# Email
uv run python scripts/pipeline/publish_picks.py --year 2025 --week 15 --mode prod
```

---

## Blockers & Issues

### Resolved

- ✅ Threshold mismatch between bet generation and email reporting
- ✅ 2024 included in training data (data leakage)
- ✅ Inconsistent bet volumes between 2024 and 2025
- ✅ System Info table formatting issues

### Outstanding

- ⚠️ Model performance ~50% win rate (need >52.4% to profit at -110 odds)
- ⚠️ 10 linting errors in analysis/experiment scripts (non-critical)
- ℹ️ Missing `scripts.analyze_best_bets` module (email warning)

---

## Learnings & Patterns

### ML Workflow Best Practices

- **Always maintain train/test/deploy split** - Never include test year in training
- **Document the split explicitly** - Add `years` to experiment configs
- **Validate bet volumes** - Consistent volumes indicate proper model application
- **Use versioning** - MLflow model versions track training data changes

### Configuration Management

- **Single source of truth** - Thresholds should be defined once and reused
- **Validate consistency** - Email reporting should use same thresholds as bet generation
- **Comment important values** - Explain why thresholds were chosen

### Email Template Design

- **Clean table formatting** - Use consistent borders and spacing
- **Clear labels** - "2024 Wk X" is clearer than "Hist. Wk X"
- **Remove visual clutter** - Inconsistent shading confuses readers

---

## Next Steps

### Immediate (Next Session)

1. **Model Improvement** - Performance is break-even, need better features or thresholds
2. **Fix Linting Errors** - Clean up 10 remaining lint issues in analysis scripts
3. **Week 16 Predictions** - Generate predictions for CFP/Bowl games

### Short-term

1. **Feature Engineering** - Explore new features to improve win rate
2. **Threshold Optimization** - Re-run threshold analysis on 2024 test set
3. **Ensemble Methods** - Evaluate if ensemble improves performance

### Long-term

1. **2026 Preparation** - When 2026 arrives, retrain on 2019/2021-2024, test on 2025
2. **Alternative Architectures** - Consider neural networks, gradient boosting variants
3. **Live Monitoring** - Track 2025 performance vs 2024 test set

---

## Health Check Results

### Code Quality

```bash
✅ ruff format . - 168 files unchanged
⚠️  ruff check . - 10 errors (non-critical, in analysis scripts)
✅ pytest tests/ -v - 43 passed, 1 warning
✅ mkdocs build --quiet - Success
```

### Linting Issues (Non-blocking)

- `F841` - Unused variable `results` in `verify_ats_from_scored.py`
- `N806` - Variable naming convention (X_train, X_test) in analysis scripts
- `E731` - Lambda expression in `evaluate_ppr_models.py`

---

## Session Handoff

**Status:** ✅ Complete  
**Next Focus:** Model performance improvement or Week 16 predictions

**Context for Next Session:**

- All 2025 predictions/scores backfilled with proper train/test split models
- Models trained on 2019/2021-2023 only (v5 in Production)
- 2024 test performance: 51.3% spread, 58.9% total
- 2025 live performance: 49.2% spread, 53.2% total
- Week 15 production email sent successfully

**Quick Start Commands:**

```bash
# Generate Week 16 predictions (if needed)
uv run python scripts/pipeline/generate_weekly_bets.py --year 2025 --week 16

# Analyze 2024 test set for threshold optimization
uv run python scripts/analysis/optimize_thresholds.py --year 2024

# Review model performance
uv run python scripts/analysis/verify_baseline_2024.py
```

---

**Artifacts Created:**

- [`docs/project_org/ml_workflow.md`](file:///Users/connorkitchings/Desktop/Repositories/cfb_model/docs/project_org/ml_workflow.md)
- Implementation plan (artifact)
- Walkthrough (artifact)
- Backfill task tracking (artifact)
- Backfill summary (artifact)
